<script>
    /**
     * Socket.IO and Initialization
     * Contains: Socket connection, real-time updates, DOMContentLoaded event, global function exports
     */

    // Initialize Socket.IO connection
    const socket = io();

    socket.on('connect', () => {
        console.log('ðŸ”Œ Connected to Socket.IO server');
    });

    socket.on('disconnect', () => {
        console.log('ðŸ”Œ Disconnected from Socket.IO server');
    });

    // Listen for real-time student updates
    socket.on('student:created', (data) => {
        console.log('New student created:', data);
        if (window.location.hash === '#students' || document.getElementById('studentsTableBody')) {
            loadStudents(); // Reload students table
        }
    });

    socket.on('student:updated', (data) => {
        console.log('Student updated:', data);
        if (window.location.hash === '#students' || document.getElementById('studentsTableBody')) {
            loadStudents(); // Reload students table
        }
    });

    socket.on('student:deleted', (data) => {
        console.log('Student deleted:', data);
        if (window.location.hash === '#students' || document.getElementById('studentsTableBody')) {
            loadStudents(); // Reload students table
        }
    });

    // Listen for real-time teacher updates
    socket.on('teacher:created', (data) => {
        console.log('New teacher created:', data);
        if (window.location.hash === '#teachers' || document.getElementById('teachersTableBody')) {
            loadTeachers(); // Reload teachers table
        }
    });

    socket.on('teacher:updated', (data) => {
        console.log('Teacher updated:', data);
        if (window.location.hash === '#teachers' || document.getElementById('teachersTableBody')) {
            loadTeachers(); // Reload teachers table
        }
    });

    socket.on('teacher:deleted', (data) => {
        console.log('Teacher deleted:', data);
        if (window.location.hash === '#teachers' || document.getElementById('teachersTableBody')) {
            loadTeachers(); // Reload teachers table
        }
    });

    // Listen for real-time admin updates
    socket.on('admin:created', (data) => {
        console.log('New admin created:', data);
        if (window.location.hash === '#admins' || document.getElementById('adminsTableBody')) {
            loadAdmins(); // Reload admins table
        }
    });

    // Listen for online users updates
    socket.on('users:online', (data) => {
        updateOnlineUsers(data.users);
    });

    // To-Do List functionality
    let todos = JSON.parse(localStorage.getItem('adminTodos')) || [];

    function renderTodos() {
        const todoList = document.getElementById('todoList');
        if (!todoList) return;

        if (todos.length === 0) {
            todoList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8"><p>No tasks yet. Click "Add Task" to create one.</p></div>';
            return;
        }

        todoList.innerHTML = todos.map((todo, index) => `
            <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                       onchange="toggleTodo(${index})"
                       class="w-4 h-4 text-indigo-600 rounded">
                <span class="flex-1 ${todo.completed ? 'line-through text-gray-500' : 'text-gray-900 dark:text-white'}">${todo.text}</span>
                <button onclick="deleteTodo(${index})" class="text-red-500 hover:text-red-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>
        `).join('');
    }

    function addTodo() {
        const text = prompt('Enter task:');
        if (text && text.trim()) {
            todos.push({ text: text.trim(), completed: false });
            localStorage.setItem('adminTodos', JSON.stringify(todos));
            renderTodos();
        }
    }

    function toggleTodo(index) {
        todos[index].completed = !todos[index].completed;
        localStorage.setItem('adminTodos', JSON.stringify(todos));
        renderTodos();
    }

    function deleteTodo(index) {
        todos.splice(index, 1);
        localStorage.setItem('adminTodos', JSON.stringify(todos));
        renderTodos();
    }

    function updateOnlineUsers(users) {
        const onlineUsersDiv = document.getElementById('onlineUsers');
        if (!onlineUsersDiv) return;

        if (!users || users.length === 0) {
            onlineUsersDiv.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8"><p>No users online</p></div>';
            return;
        }

        onlineUsersDiv.innerHTML = users.map(user => `
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center">
                        <span class="text-sm font-medium text-indigo-600 dark:text-indigo-400">
                            ${(user.name || 'U').charAt(0).toUpperCase()}
                        </span>
                    </div>
                    <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-gray-800 rounded-full"></span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 dark:text-white truncate">${user.name || 'Unknown'}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${user.role || 'user'}</p>
                </div>
            </div>
        `).join('');
    }

    // Initialize data loading when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Load initial data for dashboard tab if needed
        renderTodos();
        // Request online users from server
        socket.emit('request:online-users');
    });

    // Expose functions to global scope for Alpine.js
    window.submitAdminForm = submitAdminForm;
    window.updateAdmin = updateAdmin;
    window.submitTeacherForm = submitTeacherForm;
    window.submitStudentForm = submitStudentForm;
    window.updateTeacher = updateTeacher;
    window.updateStudent = updateStudent;
    window.editStudent = editStudent;
    window.editTeacher = editTeacher;
    window.editAdmin = editAdmin;
    window.deleteStudent = deleteStudent;
    window.deleteTeacher = deleteTeacher;
    window.deleteAdmin = deleteAdmin;
    window.addTodo = addTodo;
    window.toggleTodo = toggleTodo;
    window.deleteTodo = deleteTodo;
</script>
