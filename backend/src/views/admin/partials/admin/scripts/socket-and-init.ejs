<script>
    /**
     * Socket.IO and Initialization
     * Contains: Socket connection, real-time updates, DOMContentLoaded event, global function exports
     */

    // Initialize Socket.IO connection
    const socket = io();

    socket.on('connect', () => {
        console.log('ðŸ”Œ Connected to Socket.IO server');
    });

    socket.on('disconnect', () => {
        console.log('ðŸ”Œ Disconnected from Socket.IO server');
    });

    // Listen for real-time student updates
    socket.on('student:created', (data) => {
        console.log('New student created:', data);
        if (window.location.hash === '#students' || document.getElementById('studentsTableBody')) {
            loadStudents(); // Reload students table
        }
    });

    socket.on('student:updated', (data) => {
        console.log('Student updated:', data);
        if (window.location.hash === '#students' || document.getElementById('studentsTableBody')) {
            loadStudents(); // Reload students table
        }
    });

    socket.on('student:deleted', (data) => {
        console.log('Student deleted:', data);
        if (window.location.hash === '#students' || document.getElementById('studentsTableBody')) {
            loadStudents(); // Reload students table
        }
    });

    // Listen for real-time teacher updates
    socket.on('teacher:created', (data) => {
        console.log('New teacher created:', data);
        if (window.location.hash === '#teachers' || document.getElementById('teachersTableBody')) {
            loadTeachers(); // Reload teachers table
        }
    });

    socket.on('teacher:updated', (data) => {
        console.log('Teacher updated:', data);
        if (window.location.hash === '#teachers' || document.getElementById('teachersTableBody')) {
            loadTeachers(); // Reload teachers table
        }
    });

    socket.on('teacher:deleted', (data) => {
        console.log('Teacher deleted:', data);
        if (window.location.hash === '#teachers' || document.getElementById('teachersTableBody')) {
            loadTeachers(); // Reload teachers table
        }
    });

    // Listen for real-time admin updates
    socket.on('admin:created', (data) => {
        console.log('New admin created:', data);
        if (window.location.hash === '#admins' || document.getElementById('adminsTableBody')) {
            loadAdmins(); // Reload admins table
        }
    });

    // Listen for online users updates
    socket.on('users:online', (data) => {
        updateOnlineUsers(data.users);
    });

    // Notice Board functionality
    let notices = JSON.parse(localStorage.getItem('adminNotices')) || [];

    function renderNotices() {
        const noticeBoard = document.getElementById('noticeBoard');
        if (!noticeBoard) return;

        if (notices.length === 0) {
            noticeBoard.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8"><p>No notices yet. Click "Add Notice" to create one.</p></div>';
            return;
        }

        noticeBoard.innerHTML = notices.map((notice, index) => `
            <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg border-l-4 border-indigo-500">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="px-2 py-1 text-xs font-semibold rounded ${notice.priority === 'high' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : notice.priority === 'medium' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'}">
                                ${notice.priority === 'high' ? 'ðŸ”´ Urgent' : notice.priority === 'medium' ? 'ðŸŸ¡ Important' : 'ðŸŸ¢ Info'}
                            </span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">${notice.date}</span>
                        </div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">${notice.title}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-300">${notice.description}</p>
                    </div>
                    <button onclick="deleteNotice(${index})" class="ml-2 text-red-500 hover:text-red-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function addNotice() {
        const title = prompt('Enter notice title:');
        if (!title || !title.trim()) return;
        
        const description = prompt('Enter notice description:');
        if (!description || !description.trim()) return;
        
        const priority = prompt('Enter priority (high/medium/low):', 'medium');
        const validPriority = ['high', 'medium', 'low'].includes(priority.toLowerCase()) ? priority.toLowerCase() : 'medium';
        
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        notices.unshift({
            title: title.trim(),
            description: description.trim(),
            priority: validPriority,
            date: dateStr
        });
        
        localStorage.setItem('adminNotices', JSON.stringify(notices));
        renderNotices();
    }

    function deleteNotice(index) {
        if (confirm('Are you sure you want to delete this notice?')) {
            notices.splice(index, 1);
            localStorage.setItem('adminNotices', JSON.stringify(notices));
            renderNotices();
        }
    }

    function updateOnlineUsers(users) {
        const onlineUsersDiv = document.getElementById('onlineUsers');
        if (!onlineUsersDiv) return;

        if (!users || users.length === 0) {
            onlineUsersDiv.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8"><p>No users online</p></div>';
            return;
        }

        onlineUsersDiv.innerHTML = users.map(user => `
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center">
                        <span class="text-sm font-medium text-indigo-600 dark:text-indigo-400">
                            ${(user.name || 'U').charAt(0).toUpperCase()}
                        </span>
                    </div>
                    <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-gray-800 rounded-full"></span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 dark:text-white truncate">${user.name || 'Unknown'}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${user.role || 'user'}</p>
                </div>
            </div>
        `).join('');
    }

    // Initialize data loading when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Load initial data for dashboard tab if needed
        renderNotices();
        // Request online users from server
        socket.emit('request:online-users');
    });

    // Expose functions to global scope for Alpine.js
    window.submitAdminForm = submitAdminForm;
    window.updateAdmin = updateAdmin;
    window.submitTeacherForm = submitTeacherForm;
    window.submitStudentForm = submitStudentForm;
    window.updateTeacher = updateTeacher;
    window.updateStudent = updateStudent;
    window.editStudent = editStudent;
    window.editTeacher = editTeacher;
    window.editAdmin = editAdmin;
    window.deleteStudent = deleteStudent;
    window.deleteTeacher = deleteTeacher;
    window.deleteAdmin = deleteAdmin;
    window.addNotice = addNotice;
    window.deleteNotice = deleteNotice;
</script>
