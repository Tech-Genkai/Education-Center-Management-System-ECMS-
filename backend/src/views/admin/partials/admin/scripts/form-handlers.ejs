<script>
    /**
     * Form Submission Handlers
     * Contains: submitStudentForm, submitTeacherForm, submitClassForm, submitSubjectForm, 
     *           submitAdminFormGlobal, updateStudent, updateTeacher, updateAdminGlobal,
     *           editStudent, editTeacher, editAdmin
     */

    const formatISOToDDMMYYYY = (value) => {
        if (!value) return '';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '';
        const dd = String(date.getUTCDate()).padStart(2, '0');
        const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
        const yyyy = date.getUTCFullYear();
        return `${dd}/${mm}/${yyyy}`;
    };

    const toISOFromDDMMYYYY = (value) => {
        if (!value) return '';
        const parts = value.split(/[\/\-]/).map((p) => p.trim());
        if (parts.length !== 3) return '';
        const [dd, mm, yyyy] = parts;
        const day = Number(dd);
        const month = Number(mm);
        const year = Number(yyyy);
        if (!day || !month || !year || month < 1 || month > 12 || day < 1 || day > 31) return '';
        const iso = new Date(Date.UTC(year, month - 1, day)).toISOString().split('T')[0];
        return iso;
    };

    const normalizeDatePayload = (data) => {
        if (!data || !data.dateOfBirth) return data;
        const iso = toISOFromDDMMYYYY(data.dateOfBirth);
        if (iso) {
            data.dateOfBirth = iso;
        } else {
            delete data.dateOfBirth;
        }
        return data;
    };

    // Expose helpers for other scripts (profile handlers reuse these)
    window.formatISOToDDMMYYYY = formatISOToDDMMYYYY;
    window.normalizeDatePayload = normalizeDatePayload;
    window.toISOFromDDMMYYYY = toISOFromDDMMYYYY;

    // Submit Student Form
    async function submitStudentForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = normalizeDatePayload(Object.fromEntries(formData.entries()));
        
        try {
            const response = await fetch('/api/students', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Student added successfully!');
                showModal = false;
                loadStudents();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to add student'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add student');
        }
    }

    // Submit Teacher Form
    async function submitTeacherForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/api/teachers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Teacher added successfully!');
                showModal = false;
                loadTeachers();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to add teacher'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add teacher');
        }
    }

    // Submit Class Form
    async function submitClassForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/api/classes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Class added successfully!');
                showModal = false;
                loadClasses();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to add class'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add class');
        }
    }

    // Submit Subject Form
    async function submitSubjectForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/api/subjects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Subject added successfully!');
                showModal = false;
                loadSubjects();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to add subject'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add subject');
        }
    }

    // Global Fallback for Admin Submission
    window.submitAdminFormGlobal = async function(e) {
        e.preventDefault();
        console.log('DEBUG: Global submitAdminForm called');
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Remove empty string values - let backend use optional/default values
        Object.keys(data).forEach(key => {
            if (data[key] === '' || data[key] === null || data[key] === undefined) {
                delete data[key];
            }
        });
        
        console.log('DEBUG: Form data being sent:', data);
        
        try {
            const response = await fetch('/api/superadmins', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                // Close modal via Alpine access - find the Alpine component
                const alpineEl = document.querySelector('[x-data]');
                if (alpineEl && alpineEl.__x) {
                    alpineEl.__x.$data.showModal = false;
                }
                e.target.reset();
                loadAdmins();
                alert('Admin created successfully!');
            } else {
                const error = await response.json();
                console.error('Submit Admin Error:', error);
                
                // Show detailed validation errors
                if (error.errors && Array.isArray(error.errors)) {
                    const errorMessages = error.errors.map(err => `${err.path.join('.')}: ${err.message}`).join('\n');
                    alert('Validation failed:\n\n' + errorMessages);
                } else {
                    alert('Error creating admin: ' + (error.message || JSON.stringify(error)));
                }
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            alert('Failed to create admin: ' + error.message);
        }
    }

    // Edit Student Function
    async function editStudent(id) {
        try {
            const response = await fetch(`/api/students/${id}`, { credentials: 'include' });
            const data = await response.json();
            if (data.student) {
                const s = data.student;
                const form = document.querySelector('form[x-show*="addStudent"]');
                if (form) {
                    form.querySelector('[name="firstName"]').value = s.firstName || '';
                    form.querySelector('[name="lastName"]').value = s.lastName || '';
                    form.querySelector('[name="email"]').value = s.userId?.email || s.email || '';
                    form.querySelector('[name="phone"]').value = s.userId?.phone || s.phone || '';
                    form.querySelector('[name="studentId"]').value = s.studentId || '';
                    form.querySelector('[name="rollNumber"]').value = s.rollNumber || '';
                    form.querySelector('[name="dateOfBirth"]').value = formatISOToDDMMYYYY(s.dateOfBirth);
                    form.querySelector('[name="instituteEmail"]').value = s.userId?.instituteEmail || s.instituteEmail || '';
                    form.querySelector('[name="studentId_db"]').value = s._id;
                }
                const alpineData = document.querySelector('[x-data]').__x.$data;
                alpineData.modalType = 'editStudent';
                alpineData.showModal = true;
            }
        } catch (error) {
            console.error('Error fetching student:', error);
            alert('Failed to load student data');
        }
    }

    // Update Student Function
    async function updateStudent() {
        const form = document.querySelector('form[x-show*="addStudent"]');
        const id = form.querySelector('[name="studentId_db"]').value;
        const formData = new FormData(form);
        const data = normalizeDatePayload(Object.fromEntries(formData.entries()));
        
        try {
            const response = await fetch(`/api/students/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                document.querySelector('[x-data]').__x.$data.showModal = false;
                form.reset();
                loadStudents();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to update student'));
            }
        } catch (error) {
            alert('Failed to update student');
        }
    }

    // Edit Teacher Function
    async function editTeacher(id) {
        try {
            const response = await fetch(`/api/teachers/${id}`, { credentials: 'include' });
            const data = await response.json();
            if (data.teacher) {
                const t = data.teacher;
                const form = document.querySelector('form[x-show*="addTeacher"]');
                if (form) {
                    form.querySelector('[name="firstName"]').value = t.firstName || '';
                    form.querySelector('[name="lastName"]').value = t.lastName || '';
                    form.querySelector('[name="email"]').value = t.userId?.email || t.email || '';
                    form.querySelector('[name="phone"]').value = t.userId?.phone || t.phone || '';
                    form.querySelector('[name="teacherId"]').value = t.teacherId || '';
                    form.querySelector('[name="department"]').value = t.department || '';
                    form.querySelector('[name="qualification"]').value = t.qualification || '';
                    form.querySelector('[name="instituteEmail"]').value = t.userId?.instituteEmail || t.instituteEmail || '';
                    form.querySelector('[name="teacherId_db"]').value = t._id;
                }
                const alpineData = document.querySelector('[x-data]').__x.$data;
                alpineData.modalType = 'editTeacher';
                alpineData.showModal = true;
            }
        } catch (error) {
            console.error('Error fetching teacher:', error);
            alert('Failed to load teacher data');
        }
    }
    
    // Update Teacher Function
    async function updateTeacher() {
        const form = document.querySelector('form[x-show*="addTeacher"]');
        const id = form.querySelector('[name="teacherId_db"]').value;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch(`/api/teachers/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                document.querySelector('[x-data]').__x.$data.showModal = false;
                form.reset();
                loadTeachers();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to update teacher'));
            }
        } catch (error) {
            alert('Failed to update teacher');
        }
    }

    // Edit Admin Function
    async function editAdmin(id) {
        try {
            const response = await fetch(`/api/superadmins/${id}`, { credentials: 'include' });
            const data = await response.json();
            if (data.superAdmin) {
                const a = data.superAdmin;
                const form = document.querySelector('form[x-show*="addAdmin"]');
                if (form) {
                    form.querySelector('[name="firstName"]').value = a.firstName || '';
                    form.querySelector('[name="lastName"]').value = a.lastName || '';
                    form.querySelector('[name="email"]').value = a.userId?.email || a.email || '';
                    form.querySelector('[name="phone"]').value = a.userId?.phone || a.phone || '';
                    form.querySelector('[name="adminId"]').value = a.adminId || '';
                    form.querySelector('[name="designation"]').value = a.designation || '';
                    form.querySelector('[name="department"]').value = a.department || '';
                    let hiddenId = form.querySelector('[name="adminId_db"]');
                    if (!hiddenId) {
                        hiddenId = document.createElement('input');
                        hiddenId.type = 'hidden';
                        hiddenId.name = 'adminId_db';
                        form.appendChild(hiddenId);
                    }
                    hiddenId.value = a._id;
                }
                const alpineData = document.querySelector('[x-data]').__x.$data;
                alpineData.modalType = 'editAdmin';
                alpineData.showModal = true;
            }
        } catch (error) {
            console.error('Error fetching admin:', error);
            alert('Failed to load admin data');
        }
    }

    // Global Fallback for Admin Update
    window.updateAdminGlobal = async function() {
        const form = document.querySelector('form[x-show*="addAdmin"]');
        const id = form.querySelector('[name="adminId_db"]').value;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch(`/api/superadmins/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const alpineEl = document.querySelector('[x-data]');
                if (alpineEl && alpineEl.__x) {
                    alpineEl.__x.$data.showModal = false;
                }
                form.reset();
                loadAdmins();
                alert('Admin updated successfully!');
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to update admin'));
            }
        } catch (error) {
            alert('Failed to update admin');
        }
    }

    // Expose functions to window
    window.submitStudentForm = submitStudentForm;
    window.submitTeacherForm = submitTeacherForm;
    window.submitClassForm = submitClassForm;
    window.submitSubjectForm = submitSubjectForm;
    window.updateStudent = updateStudent;
    window.updateTeacher = updateTeacher;
    window.editStudent = editStudent;
    window.editTeacher = editTeacher;
    window.editAdmin = editAdmin;
</script>
