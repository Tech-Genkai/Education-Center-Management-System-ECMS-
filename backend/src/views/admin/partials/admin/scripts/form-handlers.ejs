<script>
    /**
     * Form Submission Handlers
     * Contains: submitStudentForm, submitTeacherForm, submitClassForm, submitSubjectForm, 
     *           submitAdminFormGlobal, updateStudent, updateTeacher, updateAdminGlobal,
     *           editStudent, editTeacher, editAdmin
     */

    const formatISOToDDMMYYYY = (value) => {
        if (!value) return '';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '';
        const dd = String(date.getUTCDate()).padStart(2, '0');
        const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
        const yyyy = date.getUTCFullYear();
        return `${dd}/${mm}/${yyyy}`;
    };

    const toISOFromDDMMYYYY = (value) => {
        if (!value) return '';
        const parts = value.split(/[\/\-]/).map((p) => p.trim());
        if (parts.length !== 3) return '';
        const [dd, mm, yyyy] = parts;
        const day = Number(dd);
        const month = Number(mm);
        const year = Number(yyyy);
        if (!day || !month || !year || month < 1 || month > 12 || day < 1 || day > 31) return '';
        const iso = new Date(Date.UTC(year, month - 1, day)).toISOString().split('T')[0];
        return iso;
    };

    const normalizeDatePayload = (data) => {
        if (!data || !data.dateOfBirth) return data;
        const iso = toISOFromDDMMYYYY(data.dateOfBirth);
        if (iso) {
            data.dateOfBirth = iso;
        } else {
            delete data.dateOfBirth;
        }
        return data;
    };

    // Expose helpers for other scripts (profile handlers reuse these)
    window.formatISOToDDMMYYYY = formatISOToDDMMYYYY;
    window.normalizeDatePayload = normalizeDatePayload;
    window.toISOFromDDMMYYYY = toISOFromDDMMYYYY;

    // Submit Student Form
    async function submitStudentForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = normalizeDatePayload(Object.fromEntries(formData.entries()));
        
        try {
            const response = await fetch('/api/students', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Student added successfully!');
                showModal = false;
                loadStudents();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to add student'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add student');
        }
    }

    // Submit Teacher Form
    async function submitTeacherForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/api/teachers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Teacher added successfully!');
                showModal = false;
                loadTeachers();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to add teacher'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add teacher');
        }
    }

    // Submit Class Form
    async function submitClassForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        // Remove empty strings to avoid validation issues
        Object.keys(data).forEach(key => {
            if (data[key] === '' || data[key] === undefined) {
                delete data[key];
            }
        });
        
        try {
            const response = await fetch('/api/classes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Class added successfully!');
                // Close modal via Alpine access
                const alpineEl = document.querySelector('[x-data]');
                if (alpineEl && alpineEl.__x) {
                    alpineEl.__x.$data.showModal = false;
                }
                event.target.reset();
                loadClasses();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to add class'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add class');
        }
    }

    // Submit Subject Form
    async function submitSubjectForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/api/subjects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Subject added successfully!');
                showModal = false;
                loadSubjects();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to add subject'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to add subject');
        }
    }

    // Global Fallback for Admin Submission
    window.submitAdminFormGlobal = async function(e) {
        e.preventDefault();
        console.log('DEBUG: Global submitAdminForm called');
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Remove empty string values - let backend use optional/default values
        Object.keys(data).forEach(key => {
            if (data[key] === '' || data[key] === null || data[key] === undefined) {
                delete data[key];
            }
        });
        
        console.log('DEBUG: Form data being sent:', data);
        
        try {
            const response = await fetch('/api/superadmins', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                // Close modal via Alpine access - find the Alpine component
                const alpineEl = document.querySelector('[x-data]');
                if (alpineEl && alpineEl.__x) {
                    alpineEl.__x.$data.showModal = false;
                }
                e.target.reset();
                loadAdmins();
                alert('Admin created successfully!');
            } else {
                const error = await response.json();
                console.error('Submit Admin Error:', error);
                
                // Show detailed validation errors
                if (error.errors && Array.isArray(error.errors)) {
                    const errorMessages = error.errors.map(err => `${err.path.join('.')}: ${err.message}`).join('\n');
                    alert('Validation failed:\n\n' + errorMessages);
                } else {
                    alert('Error creating admin: ' + (error.message || JSON.stringify(error)));
                }
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            alert('Failed to create admin: ' + error.message);
        }
    }

    // Reset Student Form
    window.resetStudentForm = function() {
        const form = document.getElementById('studentForm');
        if (form) {
            form.reset();
            document.getElementById('studentId_db').value = '';
        }
    }

    // Edit Student Function
    async function editStudent(id) {
        try {
            const response = await fetch(`/api/students/${id}`, { credentials: 'include' });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                console.error('API Error:', errorData);
                alert('Failed to load student data: ' + (errorData.message || `HTTP ${response.status}`));
                return;
            }
            
            const data = await response.json();
            if (data.student) {
                const s = data.student;
                const form = document.getElementById('studentForm');
                if (form) {
                    form.querySelector('[name="firstName"]').value = s.firstName || '';
                    form.querySelector('[name="lastName"]').value = s.lastName || '';
                    form.querySelector('[name="email"]').value = s.userId?.email || s.email || '';
                    form.querySelector('[name="phone"]').value = s.userId?.phone || s.phone || '';
                    form.querySelector('[name="studentId"]').value = s.studentId || '';
                    form.querySelector('[name="rollNumber"]').value = s.rollNumber || '';
                    form.querySelector('[name="dateOfBirth"]').value = formatISOToDDMMYYYY(s.dateOfBirth);
                    form.querySelector('[name="instituteEmail"]').value = s.userId?.instituteEmail || s.instituteEmail || '';
                    document.getElementById('studentId_db').value = s._id;
                }
                // Access Alpine.js data - try body element first
                const alpineElement = document.querySelector('body[x-data]') || document.querySelector('[x-data]');
                if (alpineElement && alpineElement._x_dataStack && alpineElement._x_dataStack[0]) {
                    const alpineData = alpineElement._x_dataStack[0];
                    alpineData.modalType = 'editStudent';
                    alpineData.showModal = true;
                } else if (alpineElement && alpineElement.__x && alpineElement.__x.$data) {
                    const alpineData = alpineElement.__x.$data;
                    alpineData.modalType = 'editStudent';
                    alpineData.showModal = true;
                } else {
                    console.error('Alpine.js not found. Element:', alpineElement);
                    // Fallback: just reload the page after a short delay
                    alert('Student data loaded but modal opening failed. Page will refresh.');
                    setTimeout(() => location.reload(), 500);
                }
            } else {
                console.error('Invalid response format:', data);
                alert('Failed to load student data: Invalid response format');
            }
        } catch (error) {
            console.error('Error fetching student:', error);
            alert('Failed to load student data: ' + error.message);
        }
    }

    // Update Student Function
    async function updateStudent() {
        const form = document.getElementById('studentForm');
        const id = document.getElementById('studentId_db').value;
        if (!id) {
            alert('Error: Student ID not found');
            return;
        }
        const formData = new FormData(form);
        const data = normalizeDatePayload(Object.fromEntries(formData.entries()));
        // Remove the db id from the data payload
        delete data.studentId_db;
        
        try {
            const response = await fetch(`/api/students/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                document.querySelector('[x-data]').__x.$data.showModal = false;
                form.reset();
                document.getElementById('studentId_db').value = '';
                loadStudents();
                alert('Student updated successfully!');
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to update student'));
            }
        } catch (error) {
            console.error('Error updating student:', error);
            alert('Failed to update student');
        }
    }

    // Reset Teacher Form
    window.resetTeacherForm = function() {
        const form = document.getElementById('teacherForm');
        if (form) {
            form.reset();
            document.getElementById('teacherId_db').value = '';
        }
    }

    // Edit Teacher Function
    async function editTeacher(id) {
        try {
            const response = await fetch(`/api/teachers/${id}`, { credentials: 'include' });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                console.error('API Error:', errorData);
                alert('Failed to load teacher data: ' + (errorData.message || `HTTP ${response.status}`));
                return;
            }
            
            const data = await response.json();
            if (data.teacher) {
                const t = data.teacher;
                const form = document.getElementById('teacherForm');
                if (form) {
                    form.querySelector('[name="firstName"]').value = t.firstName || '';
                    form.querySelector('[name="lastName"]').value = t.lastName || '';
                    form.querySelector('[name="email"]').value = t.userId?.email || t.email || '';
                    form.querySelector('[name="phone"]').value = t.userId?.phone || t.phone || '';
                    form.querySelector('[name="teacherId"]').value = t.teacherId || '';
                    form.querySelector('[name="department"]').value = t.department || '';
                    form.querySelector('[name="qualification"]').value = t.qualification || '';
                    form.querySelector('[name="instituteEmail"]').value = t.userId?.instituteEmail || t.instituteEmail || '';
                    document.getElementById('teacherId_db').value = t._id;
                }
                // Access Alpine.js data - try body element first
                const alpineElement = document.querySelector('body[x-data]') || document.querySelector('[x-data]');
                if (alpineElement && alpineElement._x_dataStack && alpineElement._x_dataStack[0]) {
                    const alpineData = alpineElement._x_dataStack[0];
                    alpineData.modalType = 'editTeacher';
                    alpineData.showModal = true;
                } else if (alpineElement && alpineElement.__x && alpineElement.__x.$data) {
                    const alpineData = alpineElement.__x.$data;
                    alpineData.modalType = 'editTeacher';
                    alpineData.showModal = true;
                } else {
                    console.error('Alpine.js not found. Element:', alpineElement);
                    alert('Teacher data loaded but modal opening failed. Page will refresh.');
                    setTimeout(() => location.reload(), 500);
                }
            } else {
                console.error('Invalid response format:', data);
                alert('Failed to load teacher data: Invalid response format');
            }
        } catch (error) {
            console.error('Error fetching teacher:', error);
            alert('Failed to load teacher data: ' + error.message);
        }
    }
    
    // Update Teacher Function
    async function updateTeacher() {
        const form = document.getElementById('teacherForm');
        const id = document.getElementById('teacherId_db').value;
        if (!id) {
            alert('Error: Teacher ID not found');
            return;
        }
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        // Remove the db id from the data payload
        delete data.teacherId_db;
        
        try {
            const response = await fetch(`/api/teachers/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                document.querySelector('[x-data]').__x.$data.showModal = false;
                form.reset();
                document.getElementById('teacherId_db').value = '';
                loadTeachers();
                alert('Teacher updated successfully!');
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to update teacher'));
            }
        } catch (error) {
            console.error('Error updating teacher:', error);
            alert('Failed to update teacher');
        }
    }

    // Reset Admin Form
    window.resetAdminForm = function() {
        const form = document.getElementById('adminForm');
        if (form) {
            form.reset();
            document.getElementById('adminId_db').value = '';
        }
    }

    // Edit Admin Function
    async function editAdmin(id) {
        try {
            const response = await fetch(`/api/superadmins/${id}`, { credentials: 'include' });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                console.error('API Error:', errorData);
                alert('Failed to load admin data: ' + (errorData.message || `HTTP ${response.status}`));
                return;
            }
            
            const data = await response.json();
            if (data.superAdmin) {
                const a = data.superAdmin;
                const form = document.getElementById('adminForm');
                if (form) {
                    form.querySelector('[name="firstName"]').value = a.firstName || '';
                    form.querySelector('[name="lastName"]').value = a.lastName || '';
                    form.querySelector('[name="email"]').value = a.userId?.email || a.email || '';
                    form.querySelector('[name="phone"]').value = a.userId?.phone || a.phone || '';
                    form.querySelector('[name="adminId"]').value = a.adminId || '';
                    form.querySelector('[name="designation"]').value = a.designation || '';
                    form.querySelector('[name="department"]').value = a.department || '';
                    const instituteEmailField = form.querySelector('[name="instituteEmail"]');
                    if (instituteEmailField) {
                        instituteEmailField.value = a.userId?.instituteEmail || a.instituteEmail || '';
                    }
                    document.getElementById('adminId_db').value = a._id;
                }
                // Access Alpine.js data - try body element first
                const alpineElement = document.querySelector('body[x-data]') || document.querySelector('[x-data]');
                if (alpineElement && alpineElement._x_dataStack && alpineElement._x_dataStack[0]) {
                    const alpineData = alpineElement._x_dataStack[0];
                    alpineData.modalType = 'editAdmin';
                    alpineData.showModal = true;
                } else if (alpineElement && alpineElement.__x && alpineElement.__x.$data) {
                    const alpineData = alpineElement.__x.$data;
                    alpineData.modalType = 'editAdmin';
                    alpineData.showModal = true;
                } else {
                    console.error('Alpine.js not found. Element:', alpineElement);
                    alert('Admin data loaded but modal opening failed. Page will refresh.');
                    setTimeout(() => location.reload(), 500);
                }
            } else {
                console.error('Invalid response format:', data);
                alert('Failed to load admin data: Invalid response format');
            }
        } catch (error) {
            console.error('Error fetching admin:', error);
            alert('Failed to load admin data: ' + error.message);
        }
    }

    // Update Admin Handler (called from form)
    window.updateAdminHandler = async function() {
        const form = document.getElementById('adminForm');
        const id = document.getElementById('adminId_db').value;
        if (!id) {
            alert('Error: Admin ID not found');
            return;
        }
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        // Remove the db id from the data payload
        delete data.adminId_db;
        
        try {
            const response = await fetch(`/api/superadmins/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const alpineEl = document.querySelector('[x-data]');
                if (alpineEl && alpineEl.__x) {
                    alpineEl.__x.$data.showModal = false;
                }
                form.reset();
                document.getElementById('adminId_db').value = '';
                loadAdmins();
                alert('Admin updated successfully!');
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to update admin'));
            }
        } catch (error) {
            console.error('Error updating admin:', error);
            alert('Failed to update admin');
        }
    }

    // Submit Admin Handler (called from form)
    window.submitAdminHandler = async function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        // Remove the db id from the data payload
        delete data.adminId_db;
        
        try {
            const response = await fetch('/api/superadmins', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                document.querySelector('[x-data]').__x.$data.showModal = false;
                e.target.reset();
                loadAdmins();
                alert('Admin created successfully!');
            } else {
                const error = await response.json();
                console.error('Submit Admin Error:', error);
                alert('Error creating admin: ' + (error.message || JSON.stringify(error)));
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            alert('Failed to create admin: ' + error.message);
        }
    }

    // Global Fallback for Admin Update (kept for backward compatibility)
    window.updateAdminGlobal = window.updateAdminHandler;

    // Expose functions to window
    window.submitStudentForm = submitStudentForm;
    window.submitTeacherForm = submitTeacherForm;
    window.submitClassForm = submitClassForm;
    window.submitSubjectForm = submitSubjectForm;
    window.updateStudent = updateStudent;
    window.updateTeacher = updateTeacher;
    window.editStudent = editStudent;
    window.editTeacher = editTeacher;
    window.editAdmin = editAdmin;
    window.resetStudentForm = window.resetStudentForm || function() {};
    window.resetTeacherForm = window.resetTeacherForm || function() {};
    window.resetAdminForm = window.resetAdminForm || function() {};

    // Edit Class Function
    async function editClass(id) {
        try {
            const response = await fetch(`/api/classes/${id}`, { credentials: 'include' });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                console.error('API Error:', errorData);
                alert('Failed to load class data: ' + (errorData.message || `HTTP ${response.status}`));
                return;
            }
            
            const data = await response.json();
            if (data.class) {
                const cls = data.class;
                const form = document.getElementById('classForm');
                if (form) {
                    form.querySelector('[name="className"]').value = cls.className || '';
                    form.querySelector('[name="classCode"]').value = cls.classCode || '';
                    form.querySelector('[name="section"]').value = cls.section || '';
                    form.querySelector('[name="branch"]').value = cls.branch || '';
                    form.querySelector('[name="academicYear"]').value = cls.academicYear || '';
                    
                    // Set teacher dropdown
                    const teacherSelect = document.getElementById('classTeacherSelect');
                    if (teacherSelect) {
                        teacherSelect.value = cls.classTeacherId?._id || cls.classTeacherId || '';
                    }
                    
                    document.getElementById('classId_db').value = cls._id;
                }
                // Access Alpine.js data
                const alpineElement = document.querySelector('body[x-data]') || document.querySelector('[x-data]');
                if (alpineElement && alpineElement._x_dataStack && alpineElement._x_dataStack[0]) {
                    const alpineData = alpineElement._x_dataStack[0];
                    // Set selected subjects
                    alpineData.selectedSubjects = cls.subjects?.map(s => s._id || s) || [];
                    alpineData.modalType = 'editClass';
                    alpineData.showModal = true;
                } else if (alpineElement && alpineElement.__x && alpineElement.__x.$data) {
                    const alpineData = alpineElement.__x.$data;
                    // Set selected subjects
                    alpineData.selectedSubjects = cls.subjects?.map(s => s._id || s) || [];
                    alpineData.modalType = 'editClass';
                    alpineData.showModal = true;
                } else {
                    console.error('Alpine.js not found. Element:', alpineElement);
                    alert('Class data loaded but modal opening failed. Page will refresh.');
                    setTimeout(() => location.reload(), 500);
                }
            } else {
                console.error('Invalid response format:', data);
                alert('Failed to load class data: Invalid response format');
            }
        } catch (error) {
            console.error('Error fetching class:', error);
            alert('Failed to load class data: ' + error.message);
        }
    }

    window.editClass = editClass;

    // Edit Subject Function
    async function editSubject(id) {
        try {
            const response = await fetch(`/api/subjects/${id}`, { credentials: 'include' });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                console.error('API Error:', errorData);
                alert('Failed to load subject data: ' + (errorData.message || `HTTP ${response.status}`));
                return;
            }
            
            const data = await response.json();
            if (data.subject) {
                const subj = data.subject;
                const form = document.getElementById('subjectForm');
                if (form) {
                    form.querySelector('[name="subjectCode"]').value = subj.subjectCode || '';
                    form.querySelector('[name="subjectName"]').value = subj.subjectName || '';
                    form.querySelector('[name="credits"]').value = subj.credits || '';
                    form.querySelector('[name="branch"]').value = subj.branch || '';
                    form.querySelector('[name="classesPerWeek"]').value = subj.classesPerWeek || '';
                    form.querySelector('[name="semester"]').value = subj.semester || '';
                    form.querySelector('[name="description"]').value = subj.description || '';
                    
                    document.getElementById('subjectId_db').value = subj._id;
                }
                // Access Alpine.js data
                const alpineElement = document.querySelector('body[x-data]') || document.querySelector('[x-data]');
                if (alpineElement && alpineElement._x_dataStack && alpineElement._x_dataStack[0]) {
                    const alpineData = alpineElement._x_dataStack[0];
                    alpineData.modalType = 'editSubject';
                    alpineData.showModal = true;
                } else if (alpineElement && alpineElement.__x && alpineElement.__x.$data) {
                    const alpineData = alpineElement.__x.$data;
                    alpineData.modalType = 'editSubject';
                    alpineData.showModal = true;
                } else {
                    console.error('Alpine.js not found. Element:', alpineElement);
                    alert('Subject data loaded but modal opening failed. Page will refresh.');
                    setTimeout(() => location.reload(), 500);
                }
            } else {
                console.error('Invalid response format:', data);
                alert('Failed to load subject data: Invalid response format');
            }
        } catch (error) {
            console.error('Error fetching subject:', error);
            alert('Failed to load subject data: ' + error.message);
        }
    }

    window.editSubject = editSubject;
</script>
