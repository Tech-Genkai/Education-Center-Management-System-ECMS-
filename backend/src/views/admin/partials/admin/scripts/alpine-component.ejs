<script>
    /**
     * Alpine.js Dashboard Component Configuration
     * Contains: Alpine.js reactive component with state management and form handlers
     */

    document.addEventListener('alpine:init', () => {
        console.log('Alpine init event fired');
        
        Alpine.data('dashboard', () => ({
            // Component State
            activeTab: 'dashboard',
            showModal: false,
            modalType: '',
            editData: {},
            sidebarOpen: true,
            availableTeachers: [],
            availableSubjects: [],
            availableClasses: [],
            selectedSubjects: [],
            selectedTeacherSubjects: [],
            selectedTeacherClasses: [],

            // Initialization
            async init() {
                console.log('Dashboard component initialized, activeTab:', this.activeTab);
                await this.loadTeachersForDropdown();
                await this.loadSubjectsForDropdown();
                await this.loadClassesForDropdown();
            },

            // Load teachers for dropdown
            async loadTeachersForDropdown() {
                try {
                    const response = await fetch('/api/teachers', {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        this.availableTeachers = data.teachers || [];
                    }
                } catch (error) {
                    console.error('Error loading teachers for dropdown:', error);
                }
            },

            // Load subjects for dropdown
            async loadSubjectsForDropdown() {
                try {
                    const response = await fetch('/api/subjects', {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        this.availableSubjects = data.subjects || [];
                    }
                } catch (error) {
                    console.error('Error loading subjects for dropdown:', error);
                }
            },

            // Load classes for dropdown
            async loadClassesForDropdown() {
                try {
                    const response = await fetch('/api/classes', {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const data = await response.json();
                        this.availableClasses = data.classes || [];
                    }
                } catch (error) {
                    console.error('Error loading classes for dropdown:', error);
                }
            },

            // ==========================================
            // FORM RESET FUNCTIONS
            // ==========================================
            resetStudentForm() {
                if (window.resetStudentForm) window.resetStudentForm();
            },
            resetTeacherForm() {
                if (window.resetTeacherForm) window.resetTeacherForm();
            },
            resetAdminForm() {
                if (window.resetAdminForm) window.resetAdminForm();
            },

            // ==========================================
            // ADMIN FORM HANDLERS
            // ==========================================
            async submitAdminForm(e) {
                console.log('DEBUG: Alpine submitAdminForm called');
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                delete data.adminId_db;
                
                try {
                    const response = await fetch('/api/superadmins', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        e.target.reset();
                        loadAdmins();
                        alert('Admin created successfully!');
                    } else {
                        const error = await response.json();
                        console.error('Submit Admin Error:', error);
                        alert('Error creating admin: ' + (error.message || JSON.stringify(error)));
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    alert('Failed to create admin: ' + error.message);
                }
            },

            async updateAdmin() {
                const form = document.getElementById('adminForm');
                const id = document.getElementById('adminId_db').value;
                if (!id) {
                    alert('Error: Admin ID not found');
                    return;
                }
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                delete data.adminId_db;
                
                try {
                    const response = await fetch(`/api/superadmins/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        form.reset();
                        document.getElementById('adminId_db').value = '';
                        loadAdmins();
                        alert('Admin updated successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + (error.message || 'Failed to update admin'));
                    }
                } catch (error) {
                    console.error('Error updating admin:', error);
                    alert('Failed to update admin');
                }
            },

            // ==========================================
            // STUDENT FORM HANDLERS
            // ==========================================
            async submitStudentForm(e) {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                // Normalize date and remove empty strings
                if (window.normalizeDatePayload) {
                    window.normalizeDatePayload(data);
                }
                Object.keys(data).forEach(key => {
                    if (data[key] === '' || data[key] === undefined) {
                        delete data[key];
                    }
                });
                delete data.studentId_db;
                
                console.log('Submitting student data:', data);
                
                try {
                    const response = await fetch('/api/students', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        e.target.reset();
                        loadStudents();
                        alert('Student created successfully!');
                    } else {
                        const error = await response.json();
                        console.error('Server error response:', error);
                        const errorMsg = error.errors 
                            ? error.errors.map(e => `${e.path ? e.path.join('.') : 'field'}: ${e.message}`).join(', ') 
                            : error.message;
                        alert('Error: ' + (errorMsg || 'Failed to create student'));
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    alert('Failed to create student');
                }
            },

            async updateStudent() {
                const form = document.getElementById('studentForm');
                const id = document.getElementById('studentId_db').value;
                if (!id) {
                    alert('Error: Student ID not found');
                    return;
                }
                const formData = new FormData(form);
                let data = Object.fromEntries(formData.entries());
                
                // Normalize date
                if (window.normalizeDatePayload) {
                    data = window.normalizeDatePayload(data);
                }
                delete data.studentId_db;
                
                try {
                    const response = await fetch(`/api/students/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        form.reset();
                        document.getElementById('studentId_db').value = '';
                        loadStudents();
                        alert('Student updated successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + (error.message || 'Failed to update student'));
                    }
                } catch (error) {
                    console.error('Error updating student:', error);
                    alert('Failed to update student');
                }
            },

            // ==========================================
            // TEACHER FORM HANDLERS
            // ==========================================
            async submitTeacherForm(e) {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                // Remove empty strings to avoid validation issues
                Object.keys(data).forEach(key => {
                    if (data[key] === '' || data[key] === undefined) {
                        delete data[key];
                    }
                });
                delete data.teacherId_db;
                
                try {
                    const response = await fetch('/api/teachers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        e.target.reset();
                        loadTeachers();
                        alert('Teacher created successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + (error.message || 'Failed to create teacher'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to create teacher');
                }
            },

            async updateTeacher() {
                const form = document.getElementById('teacherForm');
                const id = document.getElementById('teacherId_db').value;
                if (!id) {
                    alert('Error: Teacher ID not found');
                    return;
                }
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                delete data.teacherId_db;
                
                try {
                    const response = await fetch(`/api/teachers/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        form.reset();
                        document.getElementById('teacherId_db').value = '';
                        loadTeachers();
                        alert('Teacher updated successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + (error.message || 'Failed to update teacher'));
                    }
                } catch (error) {
                    console.error('Error updating teacher:', error);
                    alert('Failed to update teacher');
                }
            },

            // ==========================================
            // CLASS & SUBJECT FORM HANDLERS
            // ==========================================
            async submitClassForm(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                // Handle subjects array properly
                const subjects = formData.getAll('subjects[]');
                const data = Object.fromEntries(formData.entries());
                
                // Replace subjects[] with proper subjects array
                delete data['subjects[]'];
                if (subjects.length > 0) {
                    data.subjects = subjects;
                }
                
                // Remove empty strings to avoid validation issues
                Object.keys(data).forEach(key => {
                    if (data[key] === '' || data[key] === undefined) {
                        delete data[key];
                    }
                });
                
                console.log('Submitting class data:', data);
                
                try {
                    const response = await fetch('/api/classes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        e.target.reset();
                        this.selectedSubjects = [];
                        loadClasses();
                        alert('Class added successfully!');
                    } else {
                        const error = await response.json();
                        console.error('Class creation error:', error);
                        alert('Error: ' + (error.message || 'Failed to add class'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to add class');
                }
            },

            async submitSubjectForm(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                // Convert numeric fields
                if (data.credits) data.credits = parseFloat(data.credits);
                if (data.classesPerWeek) data.classesPerWeek = parseInt(data.classesPerWeek);
                
                // Remove empty strings to avoid validation issues
                Object.keys(data).forEach(key => {
                    if (data[key] === '' || data[key] === undefined) {
                        delete data[key];
                    }
                });
                
                try {
                    const response = await fetch('/api/subjects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        e.target.reset();
                        loadSubjects();
                        alert('Subject added successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + (error.message || 'Failed to add subject'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to add subject');
                }
            },

            async updateClass() {
                const form = document.getElementById('classForm');
                const id = document.getElementById('classId_db').value;
                if (!id) {
                    alert('Error: Class ID not found');
                    return;
                }
                const formData = new FormData(form);
                
                // Handle subjects array properly
                const subjects = formData.getAll('subjects[]');
                const data = Object.fromEntries(formData.entries());
                
                // Replace subjects[] with proper subjects array
                delete data['subjects[]'];
                delete data.classId_db;
                if (subjects.length > 0) {
                    data.subjects = subjects;
                }
                
                // Remove empty strings
                Object.keys(data).forEach(key => {
                    if (data[key] === '' || data[key] === undefined) {
                        delete data[key];
                    }
                });
                
                console.log('Updating class data:', data);
                
                try {
                    const response = await fetch(`/api/classes/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        form.reset();
                        document.getElementById('classId_db').value = '';
                        this.selectedSubjects = [];
                        loadClasses();
                        alert('Class updated successfully!');
                    } else {
                        const error = await response.json();
                        console.error('Class update error:', error);
                        alert('Error: ' + (error.message || 'Failed to update class'));
                    }
                } catch (error) {
                    console.error('Error updating class:', error);
                    alert('Failed to update class');
                }
            },

            async updateSubject() {
                const form = document.getElementById('subjectForm');
                const id = document.getElementById('subjectId_db').value;
                if (!id) {
                    alert('Error: Subject ID not found');
                    return;
                }
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                delete data.subjectId_db;
                
                // Convert numeric fields
                if (data.credits) data.credits = parseFloat(data.credits);
                if (data.classesPerWeek) data.classesPerWeek = parseInt(data.classesPerWeek);
                
                // Remove empty strings
                Object.keys(data).forEach(key => {
                    if (data[key] === '' || data[key] === undefined) {
                        delete data[key];
                    }
                });
                
                try {
                    const response = await fetch(`/api/subjects/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        this.showModal = false;
                        form.reset();
                        document.getElementById('subjectId_db').value = '';
                        loadSubjects();
                        alert('Subject updated successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + (error.message || 'Failed to update subject'));
                    }
                } catch (error) {
                    console.error('Error updating subject:', error);
                    alert('Failed to update subject');
                }
            },

            // ==========================================
            // ADMIN HANDLERS FOR ALPINE FORM SUBMIT
            // ==========================================
            async submitAdminHandler(e) {
                await this.submitAdminForm(e);
            },
            async updateAdminHandler() {
                await this.updateAdmin();
            }
        }));
    });
</script>
