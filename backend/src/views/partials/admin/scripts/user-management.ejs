<script>
    /**
     * User Management Functions
     * Contains: toggleStatus, resetPassword, deleteStudent, deleteTeacher, deleteAdmin
     */

    // Helper function for fetch requests
    function fetchWithAuth(url, options = {}) {
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };
        
        return fetch(url, {
            ...options,
            headers,
            credentials: 'include'
        });
    }

    // Toggle user status (activate/deactivate)
    async function toggleStatus(userType, userId, currentStatus) {
        const action = currentStatus === 'active' ? 'deactivate' : 'activate';
        if (!confirm(`Are you sure you want to ${action} this ${userType}?`)) {
            return;
        }

        try {
            const endpoint = userType === 'student' ? '/api/students' : 
                            userType === 'teacher' ? '/api/teachers' : '/api/superadmins';
            
            const response = await fetchWithAuth(`${endpoint}/${userId}/toggle-status`, {
                method: 'PATCH'
            });

            if (response.ok) {
                alert(`${userType.charAt(0).toUpperCase() + userType.slice(1)} ${action}d successfully!`);
                // Reload the appropriate list
                if (userType === 'student') loadStudents();
                else if (userType === 'teacher') loadTeachers();
                else loadAdmins();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || `Failed to ${action} ${userType}`));
            }
        } catch (error) {
            console.error('Error:', error);
            alert(`Failed to ${action} ${userType}`);
        }
    }

    // Reset user password
    window.resetPassword = async function(userType, userId, userName, userEmail) {
        console.log('resetPassword called with:', { userType, userId, userName, userEmail });
        
        // Show the password reset modal
        const modal = document.getElementById('resetPasswordModal');
        console.log('Modal element:', modal);
        
        if (modal) {
            modal.classList.remove('hidden');
            console.log('Modal classes after remove hidden:', modal.className);
        } else {
            console.error('Modal element not found!');
            return;
        }
        
        const nameElement = document.getElementById('resetUserName');
        const emailElement = document.getElementById('resetUserEmail');
        
        if (nameElement) nameElement.textContent = userName;
        if (emailElement) emailElement.textContent = userEmail;
        
        // Store data for modal actions
        window.currentResetData = { userType, userId, userName, userEmail };
        console.log('Current reset data stored:', window.currentResetData);
    }

    // Close reset password modal
    window.closeResetModal = function() {
        document.getElementById('resetPasswordModal').classList.add('hidden');
        document.getElementById('manualPasswordInput').value = '';
        document.getElementById('manualPasswordConfirm').value = '';
        window.currentResetData = null;
    }

    // Manual password reset
    window.manualPasswordReset = async function() {
        const newPassword = document.getElementById('manualPasswordInput').value;
        const confirmPassword = document.getElementById('manualPasswordConfirm').value;
        const { userType, userId, userName } = window.currentResetData;

        if (!newPassword || !confirmPassword) {
            alert('Please enter both password fields');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('Passwords do not match');
            return;
        }

        if (newPassword.length < 8) {
            alert('Password must be at least 8 characters long');
            return;
        }

        if (!confirm(`Are you sure you want to manually reset password for ${userName}?`)) {
            return;
        }

        try {
            const endpoint = userType === 'student' ? '/api/students' : 
                            userType === 'teacher' ? '/api/teachers' : '/api/superadmins';
            
            const response = await fetchWithAuth(`${endpoint}/${userId}/reset-password`, {
                method: 'POST',
                body: JSON.stringify({ password: newPassword })
            });

            if (response.ok) {
                alert('Password reset successfully!');
                closeResetModal();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to reset password'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to reset password');
        }
    }

    // Send OTP email
    window.sendResetOTPEmail = async function() {
        const { userType, userId, userName, userEmail } = window.currentResetData;

        if (!confirm(`Send password reset OTP to ${userEmail}?`)) {
            return;
        }

        try {
            const endpoint = userType === 'student' ? '/api/students' : 
                            userType === 'teacher' ? '/api/teachers' : '/api/superadmins';
            
            const response = await fetchWithAuth(`${endpoint}/${userId}/send-reset-email`, {
                method: 'POST'
            });

            if (response.ok) {
                const data = await response.json();
                alert(`Password reset OTP sent successfully to ${data.email}!\n\nThe user can now use the "Forgot Password" link on the login page to reset their password.`);
                closeResetModal();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to send reset email'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to send reset email');
        }
    }

    // Delete Student Function
    async function deleteStudent(id) {
        if (!confirm('Are you sure you want to delete this student? This will deactivate their account.')) {
            return;
        }

        try {
            const response = await fetch(`/api/students/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                alert('Student deleted successfully!');
                loadStudents();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to delete student'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to delete student');
        }
    }

    // Delete Teacher Function
    async function deleteTeacher(id) {
        if (!confirm('Are you sure you want to delete this teacher? This will deactivate their account.')) {
            return;
        }

        try {
            const response = await fetch(`/api/teachers/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                alert('Teacher deleted successfully!');
                loadTeachers();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to delete teacher'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to delete teacher');
        }
    }

    // Delete Admin Function
    async function deleteAdmin(id) {
        if (!confirm('Are you sure you want to delete this admin? This will deactivate their account.')) {
            return;
        }

        try {
            const response = await fetch(`/api/superadmins/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                alert('Admin deleted successfully!');
                loadAdmins();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.message || 'Failed to delete admin'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to delete admin');
        }
    }

    // Expose functions to window
    window.toggleStatus = toggleStatus;
    window.deleteStudent = deleteStudent;
    window.deleteTeacher = deleteTeacher;
    window.deleteAdmin = deleteAdmin;
</script>
